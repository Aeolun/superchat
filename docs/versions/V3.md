# SuperChat V3 Specification

## Overview

V3 adds advanced channel features and privacy features. All V3 features maintain backward compatibility with V1/V2 clients.

**V3 Status:** Not Started

---

## V3 Feature List

### 1. Subchannels
**Status:** Not Started
**Priority:** High
**Estimated Effort:** 3-5 days

**Requirements:**
- Two-level channel hierarchy (Channel > Subchannel)
- CREATE_SUBCHANNEL message (0x08)
- SUBCHANNEL_CREATED broadcast (0x88)
- GET_SUBCHANNELS request, SUBCHANNEL_LIST response
- Each subchannel has own type and retention settings

**Key Changes Needed:**
- Add Subchannel table (id, channel_id FK, name, display_name, description, type, retention)
- Protocol messages already defined in PROTOCOL.md (just need implementation)
- Update Message table queries to support subchannel_id
- UI changes to show channel hierarchy

**Protocol Impact:**
- Client → Server: CREATE_SUBCHANNEL (0x08), GET_SUBCHANNELS (0x15)
- Server → Client: SUBCHANNEL_CREATED (0x88), SUBCHANNEL_LIST (0x97)
- All message operations support optional subchannel_id

**Database Migration:**
```sql
-- 006_add_subchannels.sql
CREATE TABLE IF NOT EXISTS Subchannel (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  channel_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  display_name TEXT NOT NULL,
  description TEXT,
  message_retention_hours INTEGER NOT NULL DEFAULT 168,
  subchannel_type INTEGER NOT NULL DEFAULT 1,  -- 0=chat, 1=forum
  created_at INTEGER NOT NULL,
  FOREIGN KEY (channel_id) REFERENCES Channel(id) ON DELETE CASCADE,
  UNIQUE(channel_id, name)
);

CREATE INDEX IF NOT EXISTS idx_subchannel_channel ON Subchannel(channel_id);
```

**Files to Create/Modify:**
- `pkg/database/migrations/006_add_subchannels.sql` - Subchannel table
- `pkg/protocol/messages.go` - Subchannel message implementations
- `pkg/server/handlers.go` - handleCreateSubchannel, handleGetSubchannels
- `pkg/database/database.go` - Subchannel CRUD operations
- `pkg/client/ui/` - Subchannel navigation in channel sidebar

---

### 2. Direct Messages (DMs)
**Status:** Not Started
**Priority:** Medium
**Estimated Effort:** 5-7 days

**Requirements:**
- Private channels between users (not in public channel list)
- Optional end-to-end encryption
- Support for both registered and anonymous users
- Flexible key setup flow

**Key Features:**
- When starting a DM, users can choose:
  1. Set up encryption (generate/import key)
  2. Allow unencrypted now (one-time for this DM)
  3. Allow unencrypted forever (set permanent preference)

**Key Management:**
- SSH users: SSH key automatically used for encryption
- Password users: Can generate/upload public key
- Anonymous users: Can generate session-only keypair (lost on disconnect)
- Multiple keys: Server re-encrypts channel keys when new key added

**Encryption Details:**
- Each DM has unique symmetric key (AES-256)
- Symmetric key encrypted with each participant's public key
- Stored in `ChannelAccess` table (one entry per participant per channel)
- Messages encrypted with AES-256-GCM
- Anonymous users receive channel key in plaintext (no way to encrypt it persistently)

**Protocol Messages:**
- CREATE_DM (0x17) - Client → Server
- DM_CREATED (0x97) - Server → Client
- PROVIDE_PUBLIC_KEY (0x18) - Client → Server (for encryption)
- PUBLIC_KEY_RECEIVED (0x98) - Server → Client

**Database Changes:**
- Add `is_dm` flag to Channel table
- Add ChannelAccess table (channel_id, user_id, encrypted_channel_key)
- Add PublicKey table (user_id, key_type, public_key)

**Files to Create/Modify:**
- `pkg/database/migrations/007_add_direct_messages.sql`
- `pkg/protocol/messages.go` - DM protocol messages
- `pkg/server/handlers.go` - DM creation and key management
- `pkg/client/ui/` - DM UI, encryption setup flow

---

### 3. End-to-End Encryption
**Status:** Not Started
**Priority:** Medium
**Estimated Effort:** Included in DM implementation

**Requirements:**
- AES-256-GCM for message encryption
- RSA/Ed25519 for key exchange
- Per-channel symmetric keys
- Key rotation support

**Security Considerations:**
- Use established libraries (Go's `crypto` package)
- Proper random number generation for keys/nonces
- Secure key exchange using public key cryptography
- Never log private message content
- Implement proper key storage (encrypted at rest)

**See:** Direct Messages feature (encryption is part of DM implementation)

---

### 4. Message Compression
**Status:** Not Started
**Priority:** Low
**Estimated Effort:** 1-2 days

**Requirements:**
- Compress payloads > 512 bytes
- Use LZ4 for compression
- Compress before encryption (if both are used)
- Flags byte already supports compression bit

**Protocol Impact:**
- No new protocol messages needed
- Uses existing flags byte (bit 0 = compression)
- Client and server must both support compression

**Files to Modify:**
- `pkg/protocol/frame.go` - Add compression/decompression
- Server and client handlers - Detect and handle compressed frames

---

## Implementation Priority

**Recommended order:**

1. **Subchannels** (medium complexity)
   - New table + migration
   - Multiple protocol messages
   - UI hierarchy changes
   - Estimated: 3-5 days

2. **Direct Messages + Encryption** (most complex)
   - Multiple database changes
   - Key management system
   - Encryption implementation
   - Complex UI flows
   - Estimated: 5-7 days

3. **Message Compression** (optional, low priority)
   - Performance optimization
   - Simple implementation
   - Estimated: 1-2 days

**Total V3 estimated: ~9-14 days**

---

## Database Schema Changes (V3)

### Planned Migrations

- **006_add_subchannels.sql** - Subchannel table
- **007_add_direct_messages.sql** - ChannelAccess, PublicKey tables, Channel.is_dm flag
- **008_add_compression.sql** - No schema changes (protocol-level only)

---

## Testing Requirements

All V3 features must meet coverage requirements:
- Protocol package: 90%+ coverage (enforced)
- Server package: 80-90% coverage
- Encryption: 95%+ coverage (security-critical)
- Database migrations: Path tests validating data integrity

**Migration tests must include:**
- Schema validation (tables, indexes, constraints)
- Data integrity validation (existing data preserved)
- Upgrade path testing (v2→v3)
- Encryption key migration if applicable

---

## Security Considerations

V3 introduces encryption and private messaging:

1. **Encryption:**
   - Validate all string inputs for length and content
   - Use established crypto libraries (Go's `crypto` package)
   - Proper random number generation for keys/nonces
   - Secure key storage (encrypted at rest)
   - Never log encrypted message content or keys

2. **Direct Messages:**
   - Access control (only participants can read DMs)
   - Prevent DM spam (rate limiting on DM creation)
   - Key verification (prevent MITM attacks)

3. **Key Management:**
   - Support key rotation
   - Handle compromised keys gracefully
   - Allow users to revoke keys
   - Multiple keys per user for device management

---

## Client UI Updates Needed (V3)

**Subchannels:**
- Channel sidebar: expand/collapse subchannel list
- Breadcrumb navigation: #channel > /subchannel
- Subchannel creation UI (registered users only)

**Direct Messages:**
- DM list view (separate from channels)
- DM creation: user search/selection
- Encryption setup flow:
  - Key generation/import UI
  - Encryption preference (always/once/never)
  - Key verification UI
- Lock icon for encrypted DMs

**Message Compression:**
- No UI changes needed (transparent to user)
- Optional: show compression indicator in debug mode

---

## V3 → V4 Boundary

**V4 features** (future, not planned yet):
- Multi-party DMs (3+ participants)
- Read receipts (opt-in)
- Typing indicators
- Message reactions
- Server-to-server federation
- Voice/video chat (out of scope - see CLAUDE.md)

---

## References

- **Protocol:** See `docs/PROTOCOL.md` for complete message specifications
- **V1 Spec:** See `docs/versions/V1.md` for V1 implementation
- **V2 Spec:** See `docs/versions/V2.md` for V2 implementation
- **Data Model:** See `docs/DATA_MODEL.md` for full database schema
- **Migrations:** See `docs/MIGRATIONS.md` for migration system guide

---

**Note:** V3 development has not started. V2 is complete and production-ready.
