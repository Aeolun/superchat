# SuperChat V2 Specification

## Overview

V2 adds user registration, advanced channel management, and message editing while maintaining backward compatibility with V1. All V2 features are **parallel additions** that don't break V1 clients or require V1 data migration.

## V2 Feature Status

### ✅ Completed Features

#### 1. User Registration & Authentication
**Status:** Complete (commit eabf559)

- ✅ User table with password hashing (bcrypt cost 10)
- ✅ User flags system (uint8 bitfield): admin (0x01), moderator (0x02)
- ✅ Protocol messages: AUTH_REQUEST, AUTH_RESPONSE, REGISTER_USER, REGISTER_RESPONSE
- ✅ Server-side nickname prefixes: `$` (admin), `@` (moderator), `~` (anonymous)
- ✅ Session caching of user flags for efficient display
- ✅ Normalized database design (user info stored once, looked up per message)

**Migration:** 002_add_user_table.sql

**Key Files:**
- `pkg/protocol/messages.go` - Auth/register message types
- `pkg/protocol/user_flags.go` - UserFlags type with helpers
- `pkg/server/handlers.go` - handleAuthRequest, handleRegisterUser
- `pkg/database/database.go` - User CRUD operations

#### 2. User-Created Channels
**Status:** Complete (commit eabf559)

- ✅ Registered users can create channels (anonymous users cannot)
- ✅ Protocol messages: CREATE_CHANNEL (0x07), CHANNEL_CREATED (0x87)
- ✅ Hybrid response+broadcast pattern (matches PROTOCOL.md spec)
- ✅ Foreign key constraint: Channel.created_by → User.id
- ✅ Validation: name (3-50 chars), description (max 500), retention (1h-1yr)
- ✅ V2 supports forum channels only (type 1)
- ✅ Broadcast to all connected users (except creator who gets response)

**Migration:** 003_user_created_channels.sql (with @foreign_keys=off header)

**Key Files:**
- `pkg/protocol/messages.go` - CREATE_CHANNEL, CHANNEL_CREATED messages
- `pkg/server/handlers.go` - handleCreateChannel, broadcastChannelCreated
- `pkg/database/migrations.go` - Migration metadata header support

---

### ❌ TODO: Remaining V2 Features

#### 3. SSH Connections
**Status:** Not Started

**Requirements:**
- SSH server on port 2222 (separate from TCP server)
- SSHKey table for key authentication
- Auto-registration on first SSH connect
- Fingerprint-based identity (SHA256 hash of public key)

**Key Changes Needed:**
- Add SSHKey table (fingerprint, public_key, key_type, user_id FK)
- Implement SSH server (using golang.org/x/crypto/ssh)
- SSH authentication flow:
  1. Client connects with SSH key
  2. Server computes fingerprint
  3. If fingerprint exists: authenticate as registered user
  4. If new: auto-register user with SSH username as nickname
- Update Session to track connection_type ('tcp' vs 'ssh')

**Protocol Impact:**
- No new protocol messages needed
- AUTH_RESPONSE sent automatically after SSH auth
- Client receives same binary protocol over SSH channel

**Files to Create/Modify:**
- `pkg/server/ssh_server.go` - SSH server implementation
- `pkg/database/migrations/004_add_ssh_keys.sql` - SSHKey table
- `pkg/database/database.go` - SSHKey CRUD operations
- `cmd/server/main.go` - Start both TCP and SSH servers

---

#### 4. Subchannels
**Status:** Not Started

**Requirements:**
- Two-level channel hierarchy (Channel > Subchannel)
- CREATE_SUBCHANNEL message (0x08)
- SUBCHANNEL_CREATED broadcast (0x88)
- GET_SUBCHANNELS request, SUBCHANNEL_LIST response
- Each subchannel has own type and retention settings

**Key Changes Needed:**
- Add Subchannel table (id, channel_id FK, name, display_name, description, type, retention)
- Protocol messages already defined in PROTOCOL.md (just need implementation)
- Update Message table queries to support subchannel_id
- UI changes to show channel hierarchy

**Protocol Impact:**
- Client → Server: CREATE_SUBCHANNEL (0x08), GET_SUBCHANNELS (0x15)
- Server → Client: SUBCHANNEL_CREATED (0x88), SUBCHANNEL_LIST (0x97)
- All message operations support optional subchannel_id

**Files to Create/Modify:**
- `pkg/database/migrations/005_add_subchannels.sql` - Subchannel table
- `pkg/protocol/messages.go` - Subchannel message implementations
- `pkg/server/handlers.go` - handleCreateSubchannel, handleGetSubchannels
- `pkg/database/database.go` - Subchannel CRUD operations

---

#### 5. Message Editing
**Status:** Not Started

**Requirements:**
- Users can edit their own messages (identified by author_user_id)
- EDIT_MESSAGE request, MESSAGE_EDITED broadcast
- Track edit history in MessageVersion table
- Show "(edited)" indicator in UI
- Only message author can edit (checked server-side)

**Key Changes Needed:**
- Implement EDIT_MESSAGE handler (validate ownership)
- Update Message.edited_at timestamp on edit
- Create MessageVersion entry on edit (type='edited')
- Broadcast MESSAGE_EDITED to all users in channel
- Anonymous users can edit by session (before disconnect)

**Protocol Impact:**
- Client → Server: EDIT_MESSAGE (0x0B)
- Server → Client: MESSAGE_EDITED (0x8B) - confirmation + broadcast
- MESSAGE_EDITED includes: message_id, edited_at, new_content

**Files to Modify:**
- `pkg/server/handlers.go` - handleEditMessage implementation
- `pkg/database/database.go` - UpdateMessage, CreateMessageVersion
- MessageVersion table already exists from V1 (was for delete history)

**Security:**
- V1 anonymous users: check session nickname matches author_nickname
- V2 registered users: check session user_id matches author_user_id
- Edit history stored in MessageVersion for moderation

---

## Implementation Priority

**Recommended order:**

1. **Message Editing** (easiest, builds on existing)
   - Already have MessageVersion table
   - Protocol messages defined
   - Just need handler + ownership validation
   - Estimated: 1-2 days

2. **Subchannels** (medium complexity)
   - New table + migration
   - Multiple protocol messages
   - UI hierarchy changes needed
   - Estimated: 3-5 days

3. **SSH Connections** (most complex)
   - Separate SSH server component
   - Key fingerprint cryptography
   - Auto-registration flow
   - Concurrent TCP + SSH servers
   - Estimated: 5-7 days

**Total V2 remaining: ~10-14 days**

---

## Database Schema Changes (V2)

### Completed Migrations

- **002_add_user_table.sql** - User table with user_flags, password_hash
- **003_user_created_channels.sql** - FK constraint on Channel.created_by

### Pending Migrations

- **004_add_ssh_keys.sql** (SSH feature)
```sql
CREATE TABLE IF NOT EXISTS SSHKey (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  fingerprint TEXT UNIQUE NOT NULL,  -- SHA256 hash
  public_key TEXT NOT NULL,          -- Full public key
  key_type TEXT NOT NULL,            -- 'rsa', 'ed25519', 'ecdsa'
  can_encrypt INTEGER NOT NULL DEFAULT 0,
  encryption_public_key TEXT,        -- Companion RSA key for ed25519/ecdsa
  added_at INTEGER NOT NULL,
  FOREIGN KEY (user_id) REFERENCES User(id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_ssh_fingerprint ON SSHKey(fingerprint);
CREATE INDEX IF NOT EXISTS idx_ssh_user ON SSHKey(user_id);
```

- **005_add_subchannels.sql** (Subchannel feature)
```sql
CREATE TABLE IF NOT EXISTS Subchannel (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  channel_id INTEGER NOT NULL,
  name TEXT NOT NULL,
  display_name TEXT NOT NULL,
  description TEXT,
  message_retention_hours INTEGER NOT NULL DEFAULT 168,
  subchannel_type INTEGER NOT NULL DEFAULT 1,  -- 0=chat, 1=forum
  created_at INTEGER NOT NULL,
  FOREIGN KEY (channel_id) REFERENCES Channel(id) ON DELETE CASCADE,
  UNIQUE(channel_id, name)
);

CREATE INDEX IF NOT EXISTS idx_subchannel_channel ON Subchannel(channel_id);
```

---

## Testing Requirements

All V2 features must meet coverage requirements:
- Protocol package: 90%+ coverage (enforced)
- Server package: 80-90% coverage
- Database migrations: Path tests validating data integrity

**Migration tests must include:**
- Schema validation (tables, indexes, constraints)
- Data integrity validation (existing data preserved)
- Upgrade path testing (v1→v2, v2→v3)

---

## V2 → V3 Boundary

**V3 features** (deferred, not in V2 scope):
- Direct messages (private channels)
- End-to-end encryption (RSA + AES-256-GCM)
- Key management (PROVIDE_PUBLIC_KEY)
- Chat channel type (type=0)
- Message compression (LZ4)

V2 focuses on **multi-user features** (auth, channels, editing).
V3 will add **privacy features** (DMs, encryption).

---

## Client UI Updates Needed

**For completed V2 features:**
- Registration prompt: `[Ctrl+R] Register`
- Login prompt: `[Ctrl+L] Login`
- Header shows authenticated user without `~`: `Connected: alice`
- Channel creation UI: `[Ctrl+N] New Channel` (registered users only)

**For pending V2 features:**
- SSH connection option in connect modal
- Subchannel navigation in channel sidebar
- Message edit UI: `[e] Edit` when message selected
- Edit indicator: `(edited)` timestamp in message display

---

## References

- **Protocol:** See `docs/PROTOCOL.md` for complete message specifications
- **V1 Spec:** See `docs/V1.md` for V1 implementation details
- **Data Model:** See `docs/DATA_MODEL.md` for full database schema
- **Migrations:** See `docs/MIGRATIONS.md` for migration system guide
