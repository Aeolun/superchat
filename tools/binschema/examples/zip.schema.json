{
  "config": {
    "endianness": "little_endian"
  },
  "types": {
    "ZipArchive": {
      "sequence": [
        {
          "name": "sections",
          "type": "array",
          "kind": "eof_terminated",
          "items": { "type": "PkSection" }
        }
      ]
    },

    "PkSection": {
      "sequence": [
        { "name": "magic", "type": "uint16", "description": "Always 'PK' (0x4b50)" },
        { "name": "section_type", "type": "uint16" },
        {
          "name": "body",
          "type": "discriminated_union",
          "discriminator": { "field": "section_type" },
          "variants": [
            { "when": "value == 0x0201", "type": "CentralDirEntry", "description": "Central directory entry" },
            { "when": "value == 0x0403", "type": "LocalFile", "description": "Local file header + data" },
            { "when": "value == 0x0605", "type": "EndOfCentralDir", "description": "End of central directory" },
            { "when": "value == 0x0807", "type": "DataDescriptor", "description": "Data descriptor" }
          ]
        }
      ]
    },

    "DataDescriptor": {
      "sequence": [
        {
          "name": "crc32",
          "type": "uint32",
          "description": "CRC32 checksum (must be provided manually - compressed data)"
        },
        {
          "name": "len_body_compressed",
          "type": "uint32",
          "description": "Compressed body length (must be provided manually)"
        },
        {
          "name": "len_body_uncompressed",
          "type": "uint32",
          "description": "Uncompressed body length (must be provided manually)"
        }
      ]
    },

    "LocalFile": {
      "sequence": [
        { "name": "header", "type": "LocalFileHeader" },
        {
          "name": "body",
          "type": "array",
          "kind": "field_referenced",
          "length_field": "header.len_body_compressed",
          "items": { "type": "uint8" },
          "description": "Compressed file data"
        }
      ]
    },

    "LocalFileHeader": {
      "sequence": [
        { "name": "version", "type": "uint16" },
        { "name": "flags", "type": "uint16" },
        { "name": "compression_method", "type": "uint16" },
        { "name": "file_mod_time", "type": "uint32", "description": "DOS datetime" },
        {
          "name": "crc32",
          "type": "uint32",
          "description": "CRC32 of uncompressed data (must be provided manually)"
        },
        {
          "name": "len_body_compressed",
          "type": "uint32",
          "description": "Compressed body length (user must provide - body is in parent LocalFile struct)"
        },
        {
          "name": "len_body_uncompressed",
          "type": "uint32",
          "description": "Uncompressed size (must be provided manually)"
        },
        {
          "name": "len_file_name",
          "type": "uint16",
          "computed": {
            "type": "length_of",
            "target": "file_name",
            "encoding": "utf8"
          },
          "description": "Auto-computed: UTF-8 byte length of file_name"
        },
        {
          "name": "len_extra",
          "type": "uint16",
          "computed": {
            "type": "length_of",
            "target": "extra"
          },
          "description": "Auto-computed: byte length of extra field"
        },
        {
          "name": "file_name",
          "type": "string",
          "kind": "field_referenced",
          "length_field": "len_file_name",
          "encoding": "utf8"
        },
        {
          "name": "extra",
          "type": "array",
          "kind": "field_referenced",
          "length_field": "len_extra",
          "items": { "type": "uint8" }
        }
      ]
    },

    "CentralDirEntry": {
      "sequence": [
        { "name": "version_made_by", "type": "uint16" },
        { "name": "version_needed_to_extract", "type": "uint16" },
        { "name": "flags", "type": "uint16" },
        { "name": "compression_method", "type": "uint16" },
        { "name": "file_mod_time", "type": "uint32", "description": "DOS datetime" },
        {
          "name": "crc32",
          "type": "uint32",
          "description": "CRC32 of uncompressed data (must be provided manually)"
        },
        {
          "name": "len_body_compressed",
          "type": "uint32",
          "description": "Compressed size (must be provided manually - references LocalFile)"
        },
        {
          "name": "len_body_uncompressed",
          "type": "uint32",
          "description": "Uncompressed size (must be provided manually)"
        },
        {
          "name": "len_file_name",
          "type": "uint16",
          "computed": {
            "type": "length_of",
            "target": "file_name",
            "encoding": "utf8"
          },
          "description": "Auto-computed: UTF-8 byte length of file_name"
        },
        {
          "name": "len_extra",
          "type": "uint16",
          "computed": {
            "type": "length_of",
            "target": "extra"
          },
          "description": "Auto-computed: byte length of extra field"
        },
        {
          "name": "len_comment",
          "type": "uint16",
          "computed": {
            "type": "length_of",
            "target": "comment",
            "encoding": "utf8"
          },
          "description": "Auto-computed: UTF-8 byte length of comment"
        },
        { "name": "disk_number_start", "type": "uint16" },
        { "name": "int_file_attr", "type": "uint16" },
        { "name": "ext_file_attr", "type": "uint32" },
        {
          "name": "ofs_local_header",
          "type": "uint32",
          "description": "Offset to local file header (must be provided manually - complex correlation)"
        },
        {
          "name": "file_name",
          "type": "string",
          "kind": "field_referenced",
          "length_field": "len_file_name",
          "encoding": "utf8"
        },
        {
          "name": "extra",
          "type": "array",
          "kind": "field_referenced",
          "length_field": "len_extra",
          "items": { "type": "uint8" }
        },
        {
          "name": "comment",
          "type": "string",
          "kind": "field_referenced",
          "length_field": "len_comment",
          "encoding": "utf8"
        }
      ]
    },

    "EndOfCentralDir": {
      "sequence": [
        { "name": "disk_of_end_of_central_dir", "type": "uint16" },
        { "name": "disk_of_central_dir", "type": "uint16" },
        { "name": "num_central_dir_entries_on_disk", "type": "uint16" },
        { "name": "num_central_dir_entries_total", "type": "uint16" },
        {
          "name": "len_central_dir",
          "type": "uint32",
          "description": "Length of central directory (must be provided manually - references earlier sections)"
        },
        {
          "name": "ofs_central_dir",
          "type": "uint32",
          "description": "Offset to central directory (must be provided manually - complex correlation)"
        },
        {
          "name": "len_comment",
          "type": "uint16",
          "computed": {
            "type": "length_of",
            "target": "comment",
            "encoding": "utf8"
          },
          "description": "Auto-computed: UTF-8 byte length of comment"
        },
        {
          "name": "comment",
          "type": "string",
          "kind": "field_referenced",
          "length_field": "len_comment",
          "encoding": "utf8"
        }
      ]
    }
  }
}
